@using FastGooey.Extensions
@model FastGooey.Features.Interfaces.AppleTv.Shared.Models.ViewModels.AppleTv.AppleTvProductWorkspaceViewModel

@{
    var previewMediaValue = Model.Data.PreviewMediaUrl?.Trim() ?? string.Empty;
    var hasPreviewImage = Model.ContentNode?.Config.HasImage() == true && !string.IsNullOrWhiteSpace(previewMediaValue);
    var initialPreviewSrc = string.Empty;
    const string mediaPrefix = "fastgooey:media:";

    if (hasPreviewImage)
    {
        if (previewMediaValue.StartsWith(mediaPrefix, StringComparison.OrdinalIgnoreCase))
        {
            var remainder = previewMediaValue[mediaPrefix.Length..];
            var separatorIndex = remainder.IndexOf(':');

            if (separatorIndex > 0 && separatorIndex < remainder.Length - 1)
            {
                var sourceId = remainder[..separatorIndex];
                var encodedPath = remainder[(separatorIndex + 1)..];
                var decodedPath = encodedPath;

                try
                {
                    decodedPath = Uri.UnescapeDataString(encodedPath);
                }
                catch
                {
                }

                initialPreviewSrc = Url.Action(
                    "Preview",
                    "Media",
                    new { workspaceId = Model.WorkspaceId(), sourceId, path = decodedPath }) ?? string.Empty;
            }
        }
        else
        {
            initialPreviewSrc = previewMediaValue;
        }
    }
}

<form method="post"
      hx-post="@Url.Action("SaveWorkspace", "AppleTvProduct", new { workspaceId = Model.WorkspaceId(), interfaceId = Model.InterfaceId() })"
      hx-trigger="blur from:#title, keyup[key=='Enter'] changed delay:500ms from:#title, blur from:#description, keyup[key=='Enter'] changed delay:500ms from:#description, change from:#previewMediaUrl"
      hx-target="#workspaceEditor"
      onsubmit="return false;">
    @Html.AntiForgeryToken()
    <div id="editor" class="h-full w-full flex items-center justify-center py-8 px-4">
        <div class="w-full max-w-5xl">
            <div id="interactiveEditor" class="relative mx-auto w-full max-w-4xl aspect-video border border-zinc-300 rounded-lg overflow-hidden shadow-sm bg-zinc-900 p-4">
                <div class="w-full mb-4">
                    <label for="title" class="text-xs uppercase tracking-wide text-zinc-300">Title</label>
                    <input id="title" name="Title" value="@Model.Data.Title" class="mt-1 w-full bg-zinc-800 text-zinc-100 border border-zinc-700 rounded px-3 py-2" placeholder="Click to edit title..." />
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="description" class="text-xs uppercase tracking-wide text-zinc-300">Description</label>
                        <textarea id="description" name="Description" rows="4" class="mt-1 w-full bg-zinc-800 text-zinc-100 border border-zinc-700 rounded px-3 py-2" placeholder="Click to edit description...">@Model.Data.Description</textarea>
                    </div>
                    <div>
                        <label for="previewMediaPicker" class="text-xs uppercase tracking-wide text-zinc-300">Preview Media</label>
                        <div>
                            <input type="hidden" id="previewMediaUrl" name="PreviewMediaUrl" value="@Model.Data.PreviewMediaUrl" />
                            <button type="button"
                                    id="previewMediaPicker"
                                    class="mt-1 relative w-full max-w-48 aspect-square rounded-md border border-zinc-700 bg-zinc-800 overflow-hidden cursor-pointer"
                                    onclick="openMediaPicker(this)"
                                    data-media-picker-trigger="true"
                                    data-media-picker-target="previewMediaUrl"
                                    data-media-picker-display="previewMediaUrlDisplay">
                                <img id="previewMediaUrlImage"
                                     alt="Preview media"
                                     src="@initialPreviewSrc"
                                     class="@(string.IsNullOrWhiteSpace(initialPreviewSrc) ? "hidden h-full w-full object-cover" : "h-full w-full object-cover")" />
                                <div id="previewMediaUrlPlaceholder" class="@(string.IsNullOrWhiteSpace(initialPreviewSrc) ? "absolute inset-0 flex items-center justify-center text-zinc-300 text-sm px-4 text-center" : "hidden absolute inset-0 items-center justify-center text-zinc-300 text-sm px-4 text-center")">
                                    Click to select preview media...
                                </div>
                            </button>
                        </div>
                        
                        <p id="previewMediaUrlDisplay" class="truncate text-xs text-zinc-400 ml-1 mt-1">Click to edit preview media...</p>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-3">
                    <p class="text-xs uppercase tracking-wide text-zinc-300">Related Items</p>
                    <button type="button"
                            hx-get="@Url.Action("RelatedItemPanel", "AppleTvProduct", new { workspaceId = Model.WorkspaceId(), interfaceId = Model.InterfaceId() })"
                            hx-target="#editorPanel"
                            onclick="toggleEditor()"
                            class="text-zinc-100 hover:text-white cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V9Z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <div class="w-full overflow-x-scroll">
                    <div class="flex gap-3 min-w-max">
                        @if (Model.Data.RelatedProducts.Count == 0)
                        {
                            <div class="border border-dashed border-zinc-600 rounded-md px-3 py-2 text-zinc-300 text-xs">
                                Click to edit related items...
                            </div>
                        }
                        else
                        {
                            @foreach (var relatedItem in Model.Data.RelatedProducts)
                            {
                                <button type="button"
                                        hx-get="@Url.Action("RelatedItemPanel", "AppleTvProduct", new { workspaceId = Model.WorkspaceId(), interfaceId = Model.InterfaceId(), relatedItemId = relatedItem.Id })"
                                        hx-target="#editorPanel"
                                        onclick="toggleEditor()"
                                        class="w-48 text-left rounded-md border border-zinc-700 bg-zinc-800 p-3 hover:bg-zinc-700 transition">
                                    <p class="text-zinc-100 text-sm font-semibold truncate">@(string.IsNullOrWhiteSpace(relatedItem.Title) ? "Click to edit title..." : relatedItem.Title)</p>
                                    <p class="text-zinc-400 text-xs truncate">@(string.IsNullOrWhiteSpace(relatedItem.Link) ? "Click to edit link..." : relatedItem.Link)</p>
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    (() => {
        const mediaPickerSchemePrefix = 'fastgooey:media:';
        const workspaceId = '@Model.WorkspaceId()';
        const input = document.getElementById('previewMediaUrl');
        const image = document.getElementById('previewMediaUrlImage');
        const placeholder = document.getElementById('previewMediaUrlPlaceholder');

        if (!input || !image || !placeholder || !workspaceId) {
            return;
        }

        function tryBuildFastGooeyMediaPreviewUrl(value) {
            const trimmed = (value || '').trim();
            if (!trimmed.toLowerCase().startsWith(mediaPickerSchemePrefix)) {
                return null;
            }

            const remainder = trimmed.slice(mediaPickerSchemePrefix.length);
            const separatorIndex = remainder.indexOf(':');
            if (separatorIndex < 0) {
                return null;
            }

            const sourceId = remainder.slice(0, separatorIndex);
            const encodedPath = remainder.slice(separatorIndex + 1);
            if (!sourceId || !encodedPath) {
                return null;
            }

            let decodedPath = encodedPath;
            try {
                decodedPath = decodeURIComponent(encodedPath);
            } catch {
            }

            return '/Workspaces/' + workspaceId + '/Media/preview/' + sourceId + '?path=' + encodeURIComponent(decodedPath);
        }

        function updatePreviewMediaTile() {
            const value = (input.value || '').trim();
            if (!value) {
                image.removeAttribute('src');
                image.classList.add('hidden');
                placeholder.classList.remove('hidden');
                return;
            }

            const fastGooeyPreviewUrl = tryBuildFastGooeyMediaPreviewUrl(value);
            const previewUrl = fastGooeyPreviewUrl || value;

            image.src = previewUrl;
            image.classList.remove('hidden');
            placeholder.classList.add('hidden');
        }

        image.addEventListener('error', () => {
            image.classList.add('hidden');
            placeholder.classList.remove('hidden');
        });

        input.addEventListener('change', updatePreviewMediaTile);
        updatePreviewMediaTile();
    })();
</script>
